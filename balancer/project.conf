upstream dev-powertwin { server gitlab-runner:9443; }
upstream prev-powertwin { server gitlab-runner:9444; }
upstream main-powertwin { server gitlab-runner:9445; }
upstream dev-powertwin-db { server gitlab-runner:5443; }
upstream prev-powertwin-db { server gitlab-runner:5444; }
upstream main-powertwin-db { server powertwin-api:5445; }
upstream dev-powertwin-solver { server gitlab-runner:7443; }
upstream prev-powertwin-solver { server gitlab-runner:7444; }
upstream main-powertwin-solver { server gitlab-runner:7445; }

map $http_host $backend {
    default                                    "default-backend";
    dev-powertwin.power-theory.io:8880         dev-powertwin;
    prev-powertwin.power-theory.io:8880        prev-powertwin;
    main-powertwin.power-theory.io:8880        main-powertwin;
    dev-powertwin-db.power-theory.io:8880      dev-powertwin-db;
    prev-powertwin-db.power-theory.io:8880     prev-powertwin-db;
    main-powertwin-db.power-theory.io:8880     main-powertwin-db;
    dev-powertwin-solver.power-theory.io:8880  dev-powertwin-solver;
    prev-powertwin-solver.power-theory.io:8880 prev-powertwin-solver;
    main-powertwin-solver.power-theory.io:8880 main-powertwin-solver;
}

server {
    listen 0.0.0.0:80;
    listen [::]:80 ipv6only=on;
    server_name _;

    location / {
        proxy_pass http://$backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        error_log  /var/log/nginx/error.log warn;
        access_log /var/log/nginx/access.log combined;

        if ($backend = "default-backend") {
            return 502 "Backend not found: $http_host";
        }
    }
}

# # HTTPS servers for PowerTwin project branches
# server {
#     listen 443 ssl;

#     server_name dev-powertwin.power-theory.io;
#     ssl_certificate /etc/letsencrypt/live/dev-powertwin.power-theory.io/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/dev-powertwin.power-theory.io/privkey.pem;

#     location / {
#         proxy_pass http://localhost:9443;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }

# server {
#     listen 443 ssl;

#     server_name prev-powertwin.power-theory.io;
#     ssl_certificate /etc/letsencrypt/live/prev-powertwin.power-theory.io/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/prev-powertwin.power-theory.io/privkey.pem;

#     location / {
#         proxy_pass http://localhost:9444;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }

# server {
#     listen 443 ssl;

#     server_name main-powertwin.power-theory.io;
#     ssl_certificate /etc/letsencrypt/live/main-powertwin.power-theory.io/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/main-powertwin.power-theory.io/privkey.pem;

#     location / {
#         proxy_pass http://localhost:9445;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }

# # HTTPS servers for PowerTwin-DB project branches
# server {
#     listen 443 ssl;

#     server_name dev-powertwin-db.power-theory.io;
#     ssl_certificate /etc/letsencrypt/live/dev-powertwin-db.power-theory.io/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/dev-powertwin-db.power-theory.io/privkey.pem;

#     location / {
#         proxy_pass http://localhost:5443;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }

# server {
#     listen 443 ssl;

#     server_name prev-powertwin-db.power-theory.io;
#     ssl_certificate /etc/letsencrypt/live/prev-powertwin-db.power-theory.io/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/prev-powertwin-db.power-theory.io/privkey.pem;

#     location / {
#         proxy_pass http://localhost:5444;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }

# server {
#     listen 443 ssl;

#     server_name main-powertwin-db.power-theory.io;
#     ssl_certificate /etc/letsencrypt/live/main-powertwin-db.power-theory.io/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/main-powertwin-db.power-theory.io/privkey.pem;

#     location / {
#         proxy_pass http://localhost:5445;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }

# # HTTPS servers for PowerTwin-Solver project branches
# server {
#     listen 443 ssl;

#     server_name dev-powertwin-solver.power-theory.io;
#     ssl_certificate /etc/letsencrypt/live/dev-powertwin-solver.power-theory.io/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/dev-powertwin-solver.power-theory.io/privkey.pem;

#     location / {
#         proxy_pass http://localhost:7443;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }

# server {
#     listen 443 ssl;

#     server_name prev-powertwin-solver.power-theory.io;
#     ssl_certificate /etc/letsencrypt/live/prev-powertwin-solver.power-theory.io/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/prev-powertwin-solver.power-theory.io/privkey.pem;

#     location / {
#         proxy_pass http://localhost:7444;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }

# server {
#     listen 443 ssl;

#     server_name main-powertwin-solver.power-theory.io;
#     ssl_certificate /etc/letsencrypt/live/main-powertwin-solver.power-theory.io/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/main-powertwin-solver.power-theory.io/privkey.pem;

#     location / {
#         proxy_pass http://localhost:7445;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }