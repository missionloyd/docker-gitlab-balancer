upstream dev-powertwin { server gitlab-runner:9443; }
upstream prev-powertwin { server gitlab-runner:9444; }
upstream main-powertwin { server gitlab-runner:9445; }
upstream dev-powertwin-db { server gitlab-runner:5443; }
upstream prev-powertwin-db { server gitlab-runner:5444; }
upstream main-powertwin-db { server powertwin-api:5445; }
upstream dev-powertwin-solver { server gitlab-runner:7443; }
upstream prev-powertwin-solver { server gitlab-runner:7444; }
upstream main-powertwin-solver { server gitlab-runner:7445; }

map $http_host $backend {
    default                                    "default-backend";
    dev-powertwin.power-theory.io:8880         dev-powertwin;
    prev-powertwin.power-theory.io:8880        prev-powertwin;
    main-powertwin.power-theory.io:8880        main-powertwin;
    dev-powertwin-db.power-theory.io:8880      dev-powertwin-db;
    prev-powertwin-db.power-theory.io:8880     prev-powertwin-db;
    main-powertwin-db.power-theory.io:8880     main-powertwin-db;
    dev-powertwin-solver.power-theory.io:8880  dev-powertwin-solver;
    prev-powertwin-solver.power-theory.io:8880 prev-powertwin-solver;
    main-powertwin-solver.power-theory.io:8880 main-powertwin-solver;
}

map $http_host $backend {
    default                                    "default-backend";
    dev-powertwin.power-theory.io:8880         dev-powertwin;
    prev-powertwin.power-theory.io:8880        prev-powertwin;
    main-powertwin.power-theory.io:8880        main-powertwin;
    dev-powertwin-db.power-theory.io:8880      dev-powertwin-db;
    prev-powertwin-db.power-theory.io:8880     prev-powertwin-db;
    main-powertwin-db.power-theory.io:8880     main-powertwin-db;
    dev-powertwin-solver.power-theory.io:8880  dev-powertwin-solver;
    prev-powertwin-solver.power-theory.io:8880 prev-powertwin-solver;
    main-powertwin-solver.power-theory.io:8880 main-powertwin-solver;
}

# HTTP Server block for redirecting to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name _;

    location / {
        return 301 https://$host:8443$request_uri;
    }
    
    error_log /var/log/nginx/http-error.log warn;
    access_log /var/log/nginx/http-access.log combined;
}

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name dev-powertwin.power-theory.io;
    ssl_certificate /etc/nginx/ssl/dev-powertwin.power-theory.io/dev-powertwin.power-theory.io.crt;
    ssl_certificate_key /etc/nginx/ssl/dev-powertwin.power-theory.io/dev-powertwin.power-theory.io.key;
    include /etc/nginx/snippets/ssl-params.conf;
    location / {
        proxy_pass http://dev-powertwin;
        include /etc/nginx/snippets/proxy-params.conf;
    }
}


server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name prev-powertwin.power-theory.io;
    ssl_certificate /etc/nginx/ssl/prev-powertwin.power-theory.io/prev-powertwin.power-theory.io.crt;
    ssl_certificate_key /etc/nginx/ssl/prev-powertwin.power-theory.io/prev-powertwin.power-theory.io.key;
    include /etc/nginx/snippets/ssl-params.conf;
    location / {
        proxy_pass http://prev-powertwin;
        include /etc/nginx/snippets/proxy-params.conf;
    }
}


server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name main-powertwin.power-theory.io;
    ssl_certificate /etc/nginx/ssl/main-powertwin.power-theory.io/main-powertwin.power-theory.io.crt;
    ssl_certificate_key /etc/nginx/ssl/main-powertwin.power-theory.io/main-powertwin.power-theory.io.key;
    include /etc/nginx/snippets/ssl-params.conf;
    location / {
        proxy_pass http://main-powertwin;
        include /etc/nginx/snippets/proxy-params.conf;
    }
}


server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name dev-powertwin-db.power-theory.io;
    ssl_certificate /etc/nginx/ssl/dev-powertwin-db.power-theory.io/dev-powertwin-db.power-theory.io.crt;
    ssl_certificate_key /etc/nginx/ssl/dev-powertwin-db.power-theory.io/dev-powertwin-db.power-theory.io.key;
    include /etc/nginx/snippets/ssl-params.conf;
    location / {
        proxy_pass http://dev-powertwin-db;
        include /etc/nginx/snippets/proxy-params.conf;
    }
}


server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name prev-powertwin-db.power-theory.io;
    ssl_certificate /etc/nginx/ssl/prev-powertwin-db.power-theory.io/prev-powertwin-db.power-theory.io.crt;
    ssl_certificate_key /etc/nginx/ssl/prev-powertwin-db.power-theory.io/prev-powertwin-db.power-theory.io.key;
    include /etc/nginx/snippets/ssl-params.conf;
    location / {
        proxy_pass http://prev-powertwin-db;
        include /etc/nginx/snippets/proxy-params.conf;
    }
}


server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name main-powertwin-db.power-theory.io;
    ssl_certificate /etc/nginx/ssl/main-powertwin-db.power-theory.io/main-powertwin-db.power-theory.io.crt;
    ssl_certificate_key /etc/nginx/ssl/main-powertwin-db.power-theory.io/main-powertwin-db.power-theory.io.key;
    include /etc/nginx/snippets/ssl-params.conf;
    location / {
        proxy_pass http://main-powertwin-db;
        include /etc/nginx/snippets/proxy-params.conf;
    }
}


server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name dev-powertwin-solver.power-theory.io;
    ssl_certificate /etc/nginx/ssl/dev-powertwin-solver.power-theory.io/dev-powertwin-solver.power-theory.io.crt;
    ssl_certificate_key /etc/nginx/ssl/dev-powertwin-solver.power-theory.io/dev-powertwin-solver.power-theory.io.key;
    include /etc/nginx/snippets/ssl-params.conf;
    location / {
        proxy_pass http://dev-powertwin-solver;
        include /etc/nginx/snippets/proxy-params.conf;
    }
}


server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name prev-powertwin-solver.power-theory.io;
    ssl_certificate /etc/nginx/ssl/prev-powertwin-solver.power-theory.io/prev-powertwin-solver.power-theory.io.crt;
    ssl_certificate_key /etc/nginx/ssl/prev-powertwin-solver.power-theory.io/prev-powertwin-solver.power-theory.io.key;
    include /etc/nginx/snippets/ssl-params.conf;
    location / {
        proxy_pass http://prev-powertwin-solver;
        include /etc/nginx/snippets/proxy-params.conf;
    }
}


server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name main-powertwin-solver.power-theory.io;
    ssl_certificate /etc/nginx/ssl/main-powertwin-solver.power-theory.io/main-powertwin-solver.power-theory.io.crt;
    ssl_certificate_key /etc/nginx/ssl/main-powertwin-solver.power-theory.io/main-powertwin-solver.power-theory.io.key;
    include /etc/nginx/snippets/ssl-params.conf;
    location / {
        proxy_pass http://main-powertwin-solver;
        include /etc/nginx/snippets/proxy-params.conf;
    }
}

